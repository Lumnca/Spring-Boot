# :golf:应用开发  #

<b id="t"></b>

:arrow_double_down:[邮件发送](#a1)

:arrow_double_down:[定时任务](#a2)

<b id="a1"></b>

### :bowling:邮件发送 ###

:arrow_double_up: [返回目录](#t)

邮件发送是一个常用的功能，包括注册时的身份验证，重要通知发送都是都会用到邮件发送。Sun公司提供了JavaMail用来实现邮件发送，但是配置烦琐，Spring中提供了
简化邮箱的配置，下面来看看怎么配置邮件发送：

这里以QQ邮箱为例，首先需要开通POP3/STMP服务或者IMAP/STMP服务，如下：

首先到你的QQ邮箱主页设置开启协议（在设置的账户里面）

![](https://github.com/Lumnca/Spring-Boot/blob/master/img/a31.png)

然后往下翻，到协议设置里开启协议，如下：

![](https://github.com/Lumnca/Spring-Boot/blob/master/img/a32.png)


根据操作会让你发送短信验证，得到验证过后，会给你一个授权码，保存好授权码，后面配置需要使用。

接下来就是搭建环境，引入依赖：

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-mail</artifactId>
        </dependency>
    </dependencies>
```

修改配置文件参数：

```java
spring.mail.host=smtp.qq.com
spring.mail.port=587
spring.mail.username=724119519@qq.com   --QQ用户名
spring.mail.password=tubzuigsfubqbdjh   --验证码
spring.mail.default-encoding=UTF-8
spring.mail.properties.mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory
spring.mail.properties.mail.debug=true;
```

配置发送邮件的方法

```java
@Component
public class MailServer {
    @Autowired
    JavaMailSender javaMailSender;
    public void sendSimpleMail(String from,String to,String cc,String subject,String content){
        SimpleMailMessage message = new SimpleMailMessage();
        message.setFrom(from);
        message.setTo(to);
        message.setCc(cc);
        message.setSubject(subject);
        message.setText(content);
        javaMailSender.send(message);
    }
}
```

* JavaMailSender 是Spring Boot在MailSenderPropertiesConfiguration类中配置好的，该类在Mail自动配置类MailSenderAutoConfiguration 中导入，因此这里注入JavaMailSender就可以使用了。

* sendSimpleMail方法的5个参数分别表示邮件发送者、收件人、抄送人、邮件主题以及邮件内容。

* 简单邮件可以直接构建一个SimpleMailMessage对象进行配置，配置完成后，通过JavaMailSender将邮件发送出去。

然后添加一个测试即可：

```java
@Controller
public class index {

    @Autowired
    MailServer mailServer;
    @GetMapping("/send")
    public String send(){
        mailServer.sendSimpleMail("724119519@qq.com","1050603098@qq.com","724119519@qq.com",
                "消息推送","测试邮件内容:\n"+new Date().toString()+"发送通知，系统消息。");

        return "发送邮件成功";
    }
}
```

注意信息配置要正确，用户名，发送者，接受者，验证码要正确。

**发送带附件的邮件**

要发送附件需要添加额外的配置：

```java
@Component
public class MailServer {
    @Autowired
    JavaMailSender javaMailSender;
    public void sendSimpleMail(String from, String to, String cc, String subject, String content, File file){

        try {
            MimeMessage mimeMessage = javaMailSender.createMimeMessage();
            MimeMessageHelper message = new MimeMessageHelper(mimeMessage,true);
            message.setFrom(from);
            message.setTo(to);
            message.setCc(cc);
            message.setSubject(subject);
            message.setText(content);
            message.addAttachment(file.getName(),file);
            javaMailSender.send(mimeMessage);
        }
        catch (Exception e){
            e.printStackTrace();
        }

    }
}
```

最后添加一个邮件文件即可：

```java
@Controller
public class index {

    @Autowired
    MailServer mailServer;
    @GetMapping("/send")
    public String send(){
        mailServer.sendSimpleMail("724119519@qq.com","1050603098@qq.com","724119519@qq.com",
                "消息推送","测试邮件内容:\n"+new Date().toString()+"发送通知，系统消息。",new File("F:\\实验室\\a30.png"));
        return "发送邮件成功";
    }
}
```

**发送带图片的资源的邮件**

有的邮件可能需要图片邮件，使用FileSystemResource就可以实现：

```java
@Component
public class MailServer {
    @Autowired
    JavaMailSender javaMailSender;
    public void sendSimpleMail(String from, String to, String subject, String content,
                               String[] srcPath,String[] redIds){
        if(srcPath.length != redIds.length){
            System.out.println("发送失败");
            return;
        }
        try {
            MimeMessage message = javaMailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message,true);
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(content,true);   //第二个参数开启HTML内容发送
            for (int i=0;i < srcPath.length;i++){
                FileSystemResource resource = new FileSystemResource(new File(srcPath[i]));
                helper.addInline(redIds[i],resource);
            }
            javaMailSender.send(message);
        }
        catch (MessagingException e){
            e.printStackTrace();
            System.out.println("发送失败");
        }
    }
}
```

接下来就是控制器：

```java
    @Autowired
    MailServer mailServer;
    @GetMapping("/send")
    public void send(HttpServletResponse response ){
        mailServer.sendSimpleMail("724119519@qq.com","1050603098@qq.com","测试邮件带图片发送",
                "<div>测试图片一</div><div><img src='cid:p01'></div>" +
                        "<div>测试图片二</div><div><img src='cid:p02'></div>",
                new String[]{"F:\\实验室\\a28.png","F:\\实验室\\a29.png"},new String[]{"p01","p02"});
        System.out.println("发送成功！");
    }
```

其中cid为静态文件路径配置，其中参数配置了文件路径。

当然可以使用Html模板来构建邮件模板。

<b id="a2"></b>

### :bowling:定时任务 ###

:arrow_double_up: [返回目录](#t)

定时任务也是常见的开发应用之一，定时发送信息，执行某些操作十分重要。简单的定时操作可以直接由注解@Scheduled注解来实现，复杂的定时任务则是由集成Quartz来实现。

**Scheduled**

@Scheduled注解使用简单，如下：

在项目启动类上开启定时启动注解@EnableScheduling

```java
@SpringBootApplication
@EnableScheduling
public class start {
    public static  void main(String[] args){
        SpringApplication.run(start.class,args);
    }
}
```


定时任务主要通过@Scheduled注解进行配置，如下：

```java
    @Scheduled(fixedDelay = 1000)
    public void  printf(){
        System.out.println("定时打印信息");
    }
```

注意方法可以在任何地方执行，不需要调用，一旦开启注解，就会执行。fixedDelay为定时时间，单位毫秒。可以设置开始延迟时间：

```java
    @Scheduled(fixedDelay = 1000,initialDelay = 5000)
    public void  printf(){
        System.out.println("定时打印信息");
    }
```

initialDelay代表开始的延迟时间。当然也可以使用cron表达式来：

```java
    @Scheduled(cron = "0 * * * * ?")
    public void  printf(){
        System.out.println("定时打印信息");
    }
```

**Quatrz**

Quatrz是一个功能丰富的开源作业调度库，它由Java写成，可以集成在任何的Java应用程序中，使用Quatrz可以创建复杂或者简单的执行计划，它又支持数据库，集群，插件以及邮件，并且支持cron表达式，具有极高的灵活性。下面介绍其使用方法：

添加依赖：

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-mail</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-quartz</artifactId>
        </dependency>
    </dependencies>
```

创建Job：

```java
public class MyJob  extends QuartzJobBean {
    private String name;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    protected void executeInternal(JobExecutionContext context){
        System.out.println("用户："+name+"打印日期:"+new Date());
    }
}
```

这是不使用注解，而是继承 QuartzJobBean抽象类，当然也可以使用普通类并添加注解@Component，但是这样不能够传递方法参数，推荐使用这种方式。其中 executeInternal方法是任务被调用是启动，name属性在配置文件中配置，接下来完成配置文件：

```java
@Configuration
public class QuartzConfig {
   /*
   *普通类Bean调用方式
   @Bean
    MethodInvokingJobDetailFactoryBean jobDetailFactoryBean1(){
        MethodInvokingJobDetailFactoryBean factoryBean = new MethodInvokingJobDetailFactoryBean();
        factoryBean.setTargetBeanName("MyJob");
        factoryBean.setTargetMethod("printf");
        return factoryBean;
    }*/
    @Bean
    JobDetailFactoryBean jobDetailFactoryBean2(){
        JobDetailFactoryBean bean = new JobDetailFactoryBean();
        bean.setJobClass(MyJob.class);         //--获取执行类
        JobDataMap jobDataMap = new JobDataMap();   //添加参数字段
        jobDataMap.put("name","sang");      
        bean.setJobDataMap(jobDataMap);
        bean.setDurability(true);
        return  bean;
    }
    //---定时操作
    @Bean
    SimpleTriggerFactoryBean simpleTriggerFactoryBean(){
        SimpleTriggerFactoryBean bean = new SimpleTriggerFactoryBean();
        bean.setJobDetail(jobDetailFactoryBean2().getObject());
        bean.setRepeatCount(3);          //执行3次
        bean.setStartDelay(2000);        //任务启动延迟时间
        bean.setRepeatInterval(1000);    //循环调用时间间隔
        return  bean;
    }
    /*
    cron表达式用法
    @Bean
    CronTriggerFactoryBean cronTriggerFactoryBean(){
        CronTriggerFactoryBean bean = new CronTriggerFactoryBean();
        bean.setJobDetail(jobDetailFactoryBean2().getObject());
        bean.setCronExpression("* * * * * ?");
        return bean;
    }
    */
    //添加任务配置
    @Bean
    SchedulerFactoryBean schedulerFactoryBean(){
        SchedulerFactoryBean bean = new SchedulerFactoryBean();
        SimpleTrigger simpleTrigger = simpleTriggerFactoryBean().getObject();  
        bean.setTriggers(simpleTrigger);  //--计时方法配置参数，可多个
        return bean;
    }
}

```

启动运行就可以看到控制台打印3条信息。





