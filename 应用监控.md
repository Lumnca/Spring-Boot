# :golf:应用监控  #

<b id="t"></b>

:arrow_double_down:[端点配置](#a1)

:arrow_double_down:[Spring Boot的简单便捷创建方式](#a2)


当一个Spring Boot项目运行时，开发者需要对Spring Boot项目进行实时监控，获取项目的运行情况，在项目出错时能够实现自动报警等。Spring Bot 提供了actuator来帮助开发者获取应用程序的实时运行数据。开发者可以选择使用HTTP端点或JMX来管理和监控应用程序，获取应用程序的运行数据，包括健康状况、应用信息、内存使用情况等。

<b id="a1"></b>

### :bowling:端点配置 ###

:arrow_double_up: [返回目录](#t)

**开启端点**

开启端点可以获取项目信息，第一步添加依赖：

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
```

开发者可以使用执行器中的端点对应用进行监控或者与应用进行交互，Spring Boot包含如下默认的端点：

|端点|端点描述|是否开启|
|:--|:------|:-------|
|auditevents |展示当前应用程序的审计事件信息|Yes |
|beans |展示所有Spring Beans信息|Yes|
|conditions|展示一个自动配置类的使用报告，该报告展示所有自动配置类及它们被使用或未被使用的原因|Yes|
|configprops |展示所有@ConfigurationProperties的列表|Yes |
|env|展示系统运行环境信息|Yes |
|flyway |展示数据库迁移路径|Yes |
|health |展示应用程序的健康信息|Yes |
|httptrace |展示 trace 信息（默认为最新的100条HTTP 请求）|Yes |
|info|展示应用的定制信息，这些定制信息以info开头|Yes |
|loggers| 展示并修改应用的日志配置|Yes|
|liquibase|展示任何Liquibase数据库迁移路径|Yes|
|metrics|展示应用程序度量信息|Yes|
|mappings |展示所有@RequestMapping路径的集合列表|Yes|
|scheduledtasks |展示应用的所有定时任务Yes|
|shutdown| 远程关闭应用接口|No|
|sessions|展示并操作Spring Session|会话Yes|
|threaddump|展示线程活动的快照|Yes|

如果是一个Web应用还包括如下端点：

|端点|端点描述|是否开启|
|:--|:------|:-------|
|heapdump|返回一个GZip压缩的hprof堆转储文件|Yes|
|joloki|a展示通过HTTP暴露的JMXbeans|Yes|
|logfile|返回日志文件内容|Yes|
|prometheus| 展示一个可以被Prometheus服务器抓取的metrics数据|Yes|

大部分端点是默认开启的只有shutdown没有开启，所以想使用需要在application文件下配置如下：

```java
management.endpoint.shutdown.enabled=true
```

如果不想暴露这么多端点可以关闭：

```java
management.endpoints.enabled-by-default=false
management.endpoint.info.enabled=false
```

**暴露端点**

如上自动开启的端点只是在JMX中是全部打开的，但是在Web应用中只有health和info端口是默认开启的。所以需要手动开启：

```java
management.endpoints.web.exposure.include=httptrace,loggers,flyway,env
```

接下只需要在输入url：`http://localhost:8080/actuator/env`或者`http://localhost:8080/actuator/loggers`即可。

如果想开启全部端口：

```java
management.endpoints.web.exposure.include=*
```

**端点保护**

由于端点只能系统管理员才能使用，所以需要权限管理设计：

```java
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
```

添加Security配置：

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity httpSecurity)throws Exception{
        httpSecurity.requestMatcher(EndpointRequest.toAnyEndpoint())
                .authorizeRequests()
                .anyRequest().hasRole("ADMIN")
                .and()
                .httpBasic();
    }
}
```

在HtpSecurity中配置所有的Endpoint都需要具有ADMIN角色才能访问，同时开启HttpBasic认证。注意，EndpointRequest.toAnyEndpoint）表示匹配所有的Endpoint，例如shutdown、mappings、health等，但是不包括开发者通过@RequestMapping注解定义的接口。这里为了演示方便，Spring Security就不连接数据库了，直接在applicaion properies中定义：

```java
spring.security.user.name=admin
spring.security.user.password=123
spring.security.user.roles=ADMIN
```

**端点缓存**

对于一些不带参数的端点请求会自动进行缓存，我们可以通过如下方式配置缓存时间：

```java
management.endpoint.beans.cache.time-to-live=100s
```

**路径映射**

默认情况下，所以端口都在暴露下/actuator/路径下，如果想更改这个设置，可以进行配置：

```java
management.endpoints.web.base-path=/              --上级路径配置
management.endpoints.web.path-mapping.health=abc       --下级路径配置
```

**CORS支持**

所以的端口都没有开启跨域，开发者可以配置开启CORS支持：

```java
management.endpoints.web.cors.allowed-methods=GET,POST
management.endpoints.web.cors.allowed-origins=http://localhost:8081
```

这个配置表示允许端点处理来自`http://localhost:8081`地址的请求，允许的请求方法为GET和POST。




















